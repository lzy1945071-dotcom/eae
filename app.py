import streamlit as st
import pandas as pd
import numpy as np
import requests
import plotly.graph_objects as go

# ================================
# Êï∞ÊçÆËé∑Âèñ
# ================================
def get_coingecko_data(symbol="ethereum", vs_currency="usd", days="90", interval="1d"):
    try:
        url = f"https://api.coingecko.com/api/v3/coins/{symbol}/market_chart"
        params = {"vs_currency": vs_currency, "days": days, "interval": interval}
        resp = requests.get(url, params=params)
        data = resp.json()
        prices = pd.DataFrame(data["prices"], columns=["ts", "price"])
        prices["time"] = pd.to_datetime(prices["ts"], unit="ms")
        df = prices.copy()
        df["open"] = df["price"]
        df["high"] = df["price"]
        df["low"] = df["price"]
        df["close"] = df["price"]
        if "total_volumes" in data:
            vols = pd.DataFrame(data["total_volumes"], columns=["ts","volume"])
            vols["time"] = pd.to_datetime(vols["ts"], unit="ms")
            df = df.merge(vols[["time","volume"]], on="time", how="left")
        else:
            df["volume"] = np.random.randint(100, 1000, len(df))
        return df[["time", "open", "high", "low", "close", "volume"]]
    except Exception as e:
        st.error(f"CoinGecko Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•: {e}")
        return pd.DataFrame()

def get_binance_data(symbol="BTCUSDT", interval="1d", limit=200):
    try:
        url = "https://api.binance.com/api/v3/klines"
        params = {"symbol": symbol.upper(), "interval": interval, "limit": limit}
        resp = requests.get(url, params=params)
        data = resp.json()
        df = pd.DataFrame(data, columns=[
            "time", "open", "high", "low", "close", "volume",
            "close_time", "qav", "num_trades", "taker_base_vol", "taker_quote_vol", "ignore"
        ])
        df["time"] = pd.to_datetime(df["time"], unit="ms")
        df[["open","high","low","close","volume"]] = df[["open","high","low","close","volume"]].astype(float)
        return df[["time", "open", "high", "low", "close", "volume"]]
    except Exception as e:
        st.error(f"Binance Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•: {e}")
        return pd.DataFrame()

def get_okx_data(symbol="BTC-USDT", bar="1D", limit=200):
    try:
        url = "https://www.okx.com/api/v5/market/candles"
        params = {"instId": symbol.upper(), "bar": bar, "limit": limit}
        resp = requests.get(url, params=params)
        data = resp.json()
        df = pd.DataFrame(data["data"], columns=[
            "time","open","high","low","close","volume","volCcy","volCcyQuote","confirm"
        ])
        df["time"] = pd.to_datetime(df["time"], unit="ms")
        df[["open","high","low","close","volume"]] = df[["open","high","low","close","volume"]].astype(float)
        return df[["time","open","high","low","close","volume"]].sort_values("time")
    except Exception as e:
        st.error(f"OKX ÂÖ¨ÂÖ±Ë°åÊÉÖÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•: {e}")
        return pd.DataFrame()

# ================================
# ÊäÄÊúØÊåáÊ†á
# ================================
def add_indicators(df, macd_fast=12, macd_slow=26, macd_signal=9, rsi_period=14):
    if df.empty: return df
    df["MA20"] = df["close"].rolling(20).mean()
    df["MA50"] = df["close"].rolling(50).mean()
    df["EMA200"] = df["close"].ewm(span=200).mean()
    # MACD
    exp1 = df["close"].ewm(span=macd_fast).mean()
    exp2 = df["close"].ewm(span=macd_slow).mean()
    df["MACD"] = exp1 - exp2
    df["Signal"] = df["MACD"].ewm(span=macd_signal).mean()
    df["Hist"] = df["MACD"] - df["Signal"]
    # RSI
    delta = df["close"].diff()
    gain = np.where(delta > 0, delta, 0)
    loss = np.where(delta < 0, -delta, 0)
    avg_gain = pd.Series(gain).rolling(rsi_period).mean()
    avg_loss = pd.Series(loss).rolling(rsi_period).mean()
    rs = avg_gain / (avg_loss + 1e-9)
    df["RSI"] = 100 - (100 / (1 + rs))
    return df

# ================================
# Á≠ñÁï•Âª∫ËÆÆ
# ================================
def strategy_suggestion(df, show_rsi, show_macd, show_volume):
    if df.empty: return "ÊöÇÊó†Êï∞ÊçÆ"
    suggestions = []
    latest = df.iloc[-1]

    # ‰ª∑Ê†º‰ΩçÁΩÆ
    min_p, max_p = df["close"].min(), df["close"].max()
    pos = (latest["close"] - min_p) / (max_p - min_p + 1e-9) * 100
    suggestions.append(f"ÂΩìÂâç‰ª∑Ê†º‰Ωç‰∫éÂéÜÂè≤Âå∫Èó¥ÁöÑ {pos:.1f}% ‰ΩçÁΩÆ")

    # ÊîØÊíëÈòªÂäõ
    recent = df.tail(20)
    support, resist = recent["low"].min(), recent["high"].max()
    suggestions.append(f"ÊîØÊíë‰Ωç ~ {support:.2f}ÔºåÈòªÂäõ‰Ωç ~ {resist:.2f}")

    if show_rsi:
        if latest["RSI"] > 70: suggestions.append("RSI Ë∂Ö‰π∞ÔºåÊ≥®ÊÑèÈ£éÈô©")
        elif latest["RSI"] < 30: suggestions.append("RSI Ë∂ÖÂçñÔºåÂèØËÉΩÂèçÂºπ")

    if show_macd:
        if latest["MACD"] > latest["Signal"]: suggestions.append("MACD ÈáëÂèâ ‚Üí ÂÅèÂ§ö")
        else: suggestions.append("MACD Ê≠ªÂèâ ‚Üí ÂÅèÁ©∫")

    if show_volume:
        avg_vol = df["volume"].tail(20).mean()
        if latest["volume"] > 1.5*avg_vol:
            suggestions.append("Êàê‰∫§ÈáèÊîæÂ§ß ‚Üí ÂèØËÉΩË∂ãÂäøÂª∂Áª≠")

    return " | ".join(suggestions)

# ================================
# ‰∏ªÁ®ãÂ∫è
# ================================
st.set_page_config(layout="wide", page_title="‰º†Â•áÈáèÂåñÁªàÁ´Ø")

st.sidebar.header("‚öôÔ∏è ÂäüËÉΩÈù¢Êùø")

# ÂäüËÉΩ 1 Êï∞ÊçÆÊ∫ê
source = st.sidebar.selectbox("Êï∞ÊçÆÊ∫êÈÄâÊã©", [
    "CoinGecko API", "Binance ÂÖ¨ÂÖ±API", "OKX ÂÖ¨ÂÖ±API", "OKX API", "TokenInsight API"
])
if source in ["OKX API", "TokenInsight API"]:
    api_url = st.sidebar.text_input("ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ")

# ÂäüËÉΩ 2 ‰∏™Ê†á
symbol = st.sidebar.text_input("‰∏™Ê†áÔºàÂ¶Ç ethereum, BTCUSDT, BTC-USDT Á≠âÔºâ", "ethereum")

# ÂäüËÉΩ 3 Âë®Êúü
interval = st.sidebar.selectbox("ÈÄâÊã©Âë®Êúü", ["1d","1h","15m","4h"])

# ÂäüËÉΩ 4 Â∏ÇÂú∫Á±ªÂûã
market_type = st.sidebar.selectbox("Â∏ÇÂú∫Á±ªÂûã", ["Âä†ÂØÜË¥ßÂ∏Å", "AËÇ°", "ÁæéËÇ°"])

# Ê†πÊçÆÂ∏ÇÂú∫Ëá™Âä®ËÆæÁΩÆÂèÇÊï∞
if market_type == "Âä†ÂØÜË¥ßÂ∏Å":
    macd_fast, macd_slow, macd_signal, rsi_period = 12, 26, 9, 14
elif market_type == "AËÇ°":
    macd_fast, macd_slow, macd_signal, rsi_period = 8, 17, 9, 6
else:  # ÁæéËÇ°
    macd_fast, macd_slow, macd_signal, rsi_period = 12, 26, 9, 14

# ÂäüËÉΩ 5 ÊäÄÊúØÊåáÊ†áÂºÄÂÖ≥
st.sidebar.subheader("üìä ÊäÄÊúØÊåáÊ†á")
show_ma20 = st.sidebar.checkbox("ÊòæÁ§∫ MA20", True)
show_ma50 = st.sidebar.checkbox("ÊòæÁ§∫ MA50", True)
show_ema200 = st.sidebar.checkbox("ÊòæÁ§∫ EMA200", True)

# ÂäüËÉΩ 6 ÂâØÂõæÂºÄÂÖ≥
st.sidebar.subheader("üìâ ÂâØÂõæÈÄâÊã©")
show_volume = st.sidebar.checkbox("ÊòæÁ§∫ Êàê‰∫§Èáè", True)
show_rsi = st.sidebar.checkbox("ÊòæÁ§∫ RSI", True)
show_macd = st.sidebar.checkbox("ÊòæÁ§∫ MACD", True)

# ÂäüËÉΩ 7 ÂâØÂõæÊòæÁ§∫Ê®°Âºè
merge_mode = st.sidebar.radio("ÂâØÂõæÊòæÁ§∫Ê®°Âºè", ["ÂàÜÁ¶ªÊ®°Âºè", "ÂêàÂπ∂Ê®°Âºè"], index=0)

# ================================
# ‰∏ªËßÜÂõæ
# ================================
st.title("üìà ‰º†Â•áÈáèÂåñ‰∫§ÊòìÁªàÁ´Ø - Á≤æËã±Áâà")

if source == "CoinGecko API":
    df = get_coingecko_data(symbol, days="180", interval=interval)
elif source == "Binance ÂÖ¨ÂÖ±API":
    df = get_binance_data(symbol if "USDT" in symbol.upper() else symbol.upper()+"USDT", interval)
elif source == "OKX ÂÖ¨ÂÖ±API":
    df = get_okx_data(symbol if "-" in symbol else symbol.upper()+"-USDT", 
                      "1H" if interval=="1h" else ("15m" if interval=="15m" else "1D"))
elif source == "OKX API":
    st.warning("OKX API Ê®°ÂºèÈúÄÁî®Êà∑ÊâãÂä®ÂØπÊé•ÔºåËøôÈáå‰ªÖÂÅöÂç†‰Ωç")
    df = pd.DataFrame()
else:
    st.warning("TokenInsight API Ê®°ÂºèÈúÄÁî®Êà∑ÊâãÂä®ÂØπÊé•ÔºåËøôÈáå‰ªÖÂÅöÂç†‰Ωç")
    df = pd.DataFrame()

df = add_indicators(df, macd_fast, macd_slow, macd_signal, rsi_period)

if not df.empty:
    # ‰∏ªÂõæ
    fig = go.Figure()
    fig.add_trace(go.Candlestick(x=df["time"], open=df["open"], high=df["high"],
                                 low=df["low"], close=df["close"], name="KÁ∫ø"))
    if show_ma20: fig.add_trace(go.Scatter(x=df["time"], y=df["MA20"], name="MA20"))
    if show_ma50: fig.add_trace(go.Scatter(x=df["time"], y=df["MA50"], name="MA50"))
    if show_ema200: fig.add_trace(go.Scatter(x=df["time"], y=df["EMA200"], name="EMA200"))
    fig.update_layout(title=f"{symbol.upper()} KÁ∫ø", xaxis_rangeslider_visible=False, height=600)
    st.plotly_chart(fig, use_container_width=True)

    # ÂâØÂõæÂ§ÑÁêÜ
    if merge_mode == "ÂàÜÁ¶ªÊ®°Âºè":
        if show_volume:
            fig_vol = go.Figure()
            colors = ["green" if df["close"].iloc[i] > df["open"].iloc[i] else "red" for i in range(len(df))]
            fig_vol.add_trace(go.Bar(x=df["time"], y=df["volume"], marker_color=colors, name="Volume"))
            st.plotly_chart(fig_vol, use_container_width=True, height=250)
        if show_rsi:
            fig_rsi = go.Figure()
            fig_rsi.add_trace(go.Scatter(x=df["time"], y=df["RSI"], name="RSI"))
            fig_rsi.add_hline(y=70, line_dash="dot", line_color="red")
            fig_rsi.add_hline(y=30, line_dash="dot", line_color="green")
            st.plotly_chart(fig_rsi, use_container_width=True, height=250)
        if show_macd:
            fig_macd = go.Figure()
            fig_macd.add_trace(go.Scatter(x=df["time"], y=df["MACD"], name="MACD"))
            fig_macd.add_trace(go.Scatter(x=df["time"], y=df["Signal"], name="Signal"))
            fig_macd.add_trace(go.Bar(x=df["time"], y=df["Hist"], name="Hist"))
            st.plotly_chart(fig_macd, use_container_width=True, height=250)

    elif merge_mode == "ÂêàÂπ∂Ê®°Âºè":
        fig_merge = go.Figure()
        if show_volume:
            colors = ["green" if df["close"].iloc[i] > df["open"].iloc[i] else "red" for i in range(len(df))]
            fig_merge.add_trace(go.Bar(x=df["time"], y=df["volume"], marker_color=colors, name="Volume"))
        if show_rsi:
            fig_merge.add_trace(go.Scatter(x=df["time"], y=df["RSI"], name="RSI"))
        if show_macd:
            fig_merge.add_trace(go.Scatter(x=df["time"], y=df["MACD"], name="MACD"))
            fig_merge.add_trace(go.Scatter(x=df["time"], y=df["Signal"], name="Signal"))
        fig_merge.update_layout(title="ÂêàÂπ∂ÂâØÂõæ", height=400)
        st.plotly_chart(fig_merge, use_container_width=True)

    # ÂÆûÊó∂Á≠ñÁï•Âç°Áâá
    st.subheader("üìå ÂÆûÊó∂Á≠ñÁï•Âª∫ËÆÆ")
    st.info(strategy_suggestion(df, show_rsi, show_macd, show_volume))

else:
    st.warning("Êú™Ëé∑ÂèñÂà∞Ë°åÊÉÖÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•Êï∞ÊçÆÊ∫êÊàñËæìÂÖ•ÁöÑÊ†áÁöÑ„ÄÇ")
